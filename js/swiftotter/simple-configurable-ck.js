/**************************** CONFIGURABLE PRODUCT **************************/Product.SimpleConfig=Class.create();Product.SimpleConfig.prototype={initialize:function(e){this.config=e;this.taxConfig=this.config.taxConfig;this.settings=$$(".super-attribute-select");this.state=new Hash;this.priceTemplate=new Template(this.config.template);this.prices=e.prices;if(window.optionsPrice!==undefined){optionsPrice.productPrice=this.config.basePrice;optionsPrice.productOldPrice=this.config.oldPrice}this.settings.each(function(e){Event.observe(e,"change",this.configure.bind(this))}.bind(this));this.settings.each(function(e){var t=e.id.replace(/[a-z]*/,"");if(t&&this.config.attributes[t]){e.config=this.config.attributes[t];e.attributeId=t;this.state[t]=!1}}.bind(this));var t=[];for(var n=this.settings.length-1;n>=0;n--){var r=this.settings[n-1]?this.settings[n-1]:!1,i=this.settings[n+1]?this.settings[n+1]:!1;n==0?this.fillSelect(this.settings[n]):this.settings[n].disabled=!0;$(this.settings[n]).childSettings=t.clone();$(this.settings[n]).prevSetting=r;$(this.settings[n]).nextSetting=i;t.push(this.settings[n])}e.defaultValues&&(this.values=e.defaultValues);var s=window.location.href.indexOf("#");if(s!=-1){var o=window.location.href.substr(s+1),u=o.toQueryParams();this.values||(this.values={});for(var n in u)this.values[n]=u[n]}this.configureForValues();document.observe("dom:loaded",this.configureForValues.bind(this))},configureForValues:function(){this.values&&this.settings.each(function(e){var t=e.attributeId;e.value=typeof this.values[t]=="undefined"?"":this.values[t];this.configureElement(e)}.bind(this));window.optionsPrice!==undefined&&this.reloadPrice()},configure:function(e){var t=Event.element(e);this.configureElement(t)},configureElement:function(e){this.reloadOptionLabels(e);if(e.value){this.state[e.config.id]=e.value;if(e.nextSetting){e.nextSetting.disabled=!1;this.fillSelect(e.nextSetting);this.resetChildren(e.nextSetting)}}else this.resetChildren(e);this.reloadPrice()},reloadProduct:function(){var e=$H(this.getSelectedOptions()),t={};e.each(function(e){var n=e.value;if(n.products!==undefined)for(var r=0;r<n.products.length;r++){var i=n.products[r],s=i.id;if(t[s]!==undefined){var o=parseInt(t[s].count);t[s].count=o+1}else{i.count=1;t[s]=i}}});var n=0,r=0,i={};$H(t).each(function(e){var t=e.key,s=e.value.price,o=e.value.count;if(o>r){r=o;n=t;i=e.value}});console.log(n);if(n===0){this.config.product=undefined;this.config.productPrice=undefined;return!1}this.config.product=n;this.config.productPrice=i.price;this.config.productStock=i.stock;return n},getSelectedOptions:function(){var e={};for(var t=this.settings.length-1;t>=0;t--){var n=this.settings[t].options[this.settings[t].selectedIndex];n.config&&(e[n.config.id]=n.config)}return e},reloadOptionLabels:function(e){var t;e.options[e.selectedIndex].config?t=parseFloat(e.options[e.selectedIndex].config.price):t=0;for(var n=0;n<e.options.length;n++)e.options[n].config&&(e.options[n].text=this.getOptionLabel(e.options[n].config,e.options[n].config.price))},resetChildren:function(e){if(e.childSettings)for(var t=0;t<e.childSettings.length;t++){e.childSettings[t].selectedIndex=0;e.childSettings[t].disabled=!0;e.config&&(this.state[e.config.id]=!1)}},fillSelect:function(e){var t=e.id.replace(/[a-z]*/,""),n=this.getAttributeOptions(t);this.clearSelect(e);e.options[0]=new Option(this.config.chooseText,"");var r=!1;e.prevSetting&&(r=e.prevSetting.options[e.prevSetting.selectedIndex]);if(n){var i=1;for(var s=0;s<n.length;s++){var o=[];if(r){for(var u=0;u<n[s].products.length;u++)if(r.config.allowedProducts)for(var a=0;a<r.config.allowedProducts.length;a++){var f=r.config.allowedProducts[a];if(f!==undefined&&n[s].products[u].id==f.id){o.push(n[s].products[u]);break}}}else o=n[s].products.clone();if(o.size()>0){n[s].allowedProducts=o;e.options[i]=new Option(this.getOptionLabel(n[s],n[s].price),n[s].id);e.options[i].config=n[s];$(e.options[i]).setAttribute("price",n[s].price);i++}}}},getOptionLabel:function(e,t){var t=parseFloat(t);if(this.taxConfig.includeTax)var n=t/(100+this.taxConfig.defaultTax)*this.taxConfig.defaultTax,r=t-n,i=r*(1+this.taxConfig.currentTax/100);else var n=t*(this.taxConfig.currentTax/100),r=t,i=r+n;this.taxConfig.showIncludeTax||this.taxConfig.showBothPrices?t=i:t=r;var s=e.label;t&&this.settings.length===1&&(this.taxConfig.showBothPrices?s+=" "+this.formatPrice(r,!1)+" ("+this.formatPrice(t,!1)+" "+this.taxConfig.inclTaxTitle+")":s+=" "+this.formatPrice(t,!1));return s},formatPrice:function(e,t){var n="";e=parseFloat(e);if(t)if(e<0){n+="-";e=-e}else n+="+";var r=(Math.round(e*100)/100).toString();this.prices&&this.prices[r]?n+=this.prices[r]:n+=this.priceTemplate.evaluate({price:e.toFixed(2)});return n},clearSelect:function(e){for(var t=e.options.length-1;t>=0;t--)e.remove(t)},getAttributeOptions:function(e){if(this.config.attributes[e])return this.config.attributes[e].options},reloadPrice:function(){if(this.config.disablePriceReload)return;this.reloadProduct();var e=0,t=0,n=!1;for(var r=this.settings.length-1;r>=0;r--){var i=this.settings[r].options[this.settings[r].selectedIndex];if(i.config){e+=parseFloat(i.config.price);t+=parseFloat(i.config.oldPrice)}else n=!0}this.config.product!==undefined&&(e=this.config.productPrice);if(n!==!0){optionsPrice.changePrice("config",{price:e,oldPrice:t});optionsPrice.reload();return e}if($("product-price-"+this.config.productId)){var s=optionsPrice.formatPrice(this.config.minPrice);this.config.minPrice!==this.config.maxPrice&&(s+=" - "+optionsPrice.formatPrice(this.config.maxPrice));$("product-price-"+this.config.productId).select(".price")[0].innerHTML=s}},reloadOldPrice:function(){if($("old-price-"+this.config.productId)){var e=parseFloat(this.config.oldPrice);for(var t=this.settings.length-1;t>=0;t--){var n=this.settings[t].options[this.settings[t].selectedIndex];if(n.config){var r=parseFloat(n.config.oldPrice);e+=isNaN(r)?0:r}}e<0&&(e=0);e=this.formatPrice(e);$("old-price-"+this.config.productId)&&($("old-price-"+this.config.productId).innerHTML=e)}}};